---
title: "Explore_chemical_correlations"
output: html_document
date: "2024-10-15"
---
```{r}
library(ggplot2)
library(reshape2)
library(stats)
library(purrr)
library(heatmaply)
library(corrplot)
library(reticulate)
```

```{python}
import pickle
import pandas as pd

injury_df = pd.read_pickle("C:/Users/Jessie PC/OneDrive - University of North Carolina at Chapel Hill/Symbolic_regression_github/NIH_Cloud_NOSI/Data_inputs/2_Chemical_measurements/injury_df")
```

```{r}
# Read in the data
data <- py$injury_df
chem_dat <- read.csv('C:\\Users\\Jessie PC\\OneDrive - University of North Carolina at Chapel Hill\\Symbolic_regression_github\\NIH_Cloud_NOSI\\Models\\2_Chemical_measurements\\pysr\\partial_deriv_Full.csv')

# Get chems of interest
chems <- unique(chem_dat$chem)

# Initialize matrices to store p-values and correlation coefficients
cols <- colnames(data)
p_values <- matrix(0, nrow = length(cols), ncol = length(cols), dimnames = list(cols, cols))
correlation_matrix <- matrix(0, nrow = length(cols), ncol = length(cols), dimnames = list(cols, cols))

# Calculate pairwise Pearson correlations and p-values
for (i in seq_along(cols)) {
  for (j in i:length(cols)) {
    if (i != j) {
      correlation_test <- cor.test(data[[cols[i]]], data[[cols[j]]], method = "pearson")
      corr <- correlation_test$estimate
      p_value <- correlation_test$p.value
      correlation_matrix[i, j] <- corr
      correlation_matrix[j, i] <- corr
      p_values[i, j] <- p_value
      p_values[j, i] <- p_value
    } else {
      correlation_matrix[i, j] <- 1
      p_values[i, j] <- 0
    }
  }
}

# Apply FDR correction to the p-values
p_values_flat <- as.vector(p_values)
p_values_corrected <- p.adjust(p_values_flat, method = "fdr")
p_values_corrected_matrix <- matrix(p_values_corrected, nrow = length(cols), ncol = length(cols), dimnames = list(cols, cols))

# Create a mask for non-significant correlations (p-value > 0.05)
significance_mask <- p_values_corrected_matrix <= 0.05

# Convert correlation matrix and mask into a format suitable for ggplot
correlation_df <- melt(correlation_matrix)
significance_mask_df <- melt(significance_mask)

# Plot heatmap where only significant correlations are colored
p <- heatmap_plot <- ggplot(data = correlation_df, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Correlation Matrix", fill = "Correlation")

# Save the plot
ggsave("Images/2_Chemical_measurements/r_correlation_heatmap.png", plot = heatmap_plot, width = 10, height = 8)

```

